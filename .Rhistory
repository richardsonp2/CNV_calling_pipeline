CNV.ND.Line$CRITERIA_MET=1
}
# 15q24	del/dup		 At	least	1Mbp	between	the	AâE	intervals
if((x=="15q24 del" | x=="15q24 dup") & greater_than_1mbp){
CNV.ND.Line$CRITERIA_MET=1
}
# 15q25	del/dup		 At	least	1Mbp	between	the	AâD	intervals
if(x=="15q25 del" & greater_than_1mbp){
CNV.ND.Line$CRITERIA_MET=1
}
# 16p13.11	del/dup		 Size	>50%	of	critical	region
if((x=="16p13.11 del" | x=="16p13.11 dup") & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# 16p12.1	del		 Size	>50%	of	critical	region
if(x=="16p12.1 del" & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# 16p11.2	distal	del/distal	dup		 Size	>50%	of	critical	region
if((x=="16p11.2 distal del" | x=="16p11.2 distal dup") & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# 16p11.2	del/dup		 Size	>50%	of	critical	region
if((x=="16p11.2 del" | x=="16p11.2 dup") & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# 17p13.3	del/dup	(YWHAE)		 Exonic	deletions;	whole	gene	duplications
if((x=="17p13.3 del (YWHAE)" | x=="17p13.3	dup (YWHAE") & size_greater_50 & length(grep("YWHAE",CNV.ND.Line$GENES))>0){
YWHAE.exon.count=as.data.frame(do.call(rbind,lapply(1:nrow(YWHAE.exon.coords),function(z){
CNV.ND.Line.Start=CNV.ND.Line[1,10]
CNV.ND.Line.End=CNV.ND.Line[1,11]
exon.whole=YWHAE.exon.coords[which(as.numeric(as.character(YWHAE.exon.coords[z,1]))>CNV.ND.Line.Start & as.numeric(as.character(YWHAE.exon.coords[z,2]))<CNV.ND.Line.End),]
if(nrow(exon.whole)>0){
exon.whole
}
})))
if(nrow(YWHAE.exon.count)>0){
CNV.ND.Line$CRITERIA_MET=1
}
}
# 17p13.3	del/dup	(PAFAH1B1) Exonic	deletions;	whole	gene	duplications
if((x=="17p13.3 del (PAFAH1B1)" | x=="17p13.3	dup (PAFAH1B1") & size_greater_50 & length(grep("PAFAH1B1",CNV.ND.Line$GENES))>0){
PAFAH1B1.exon.count=as.data.frame(do.call(rbind,lapply(1:nrow(PAFAH1B1.exon.coords),function(z){
CNV.ND.Line.Start=CNV.ND.Line[1,10]
CNV.ND.Line.End=CNV.ND.Line[1,11]
exon.whole=PAFAH1B1.exon.coords[which(as.numeric(as.character(PAFAH1B1.exon.coords[z,1]))>CNV.ND.Line.Start & as.numeric(as.character(PAFAH1B1.exon.coords[z,2]))<CNV.ND.Line.End),]
if(nrow(exon.whole)>0){
exon.whole
}
})))
if(nrow(PAFAH1B1.exon.count)>0){
CNV.ND.Line$CRITERIA_MET=1
}
}
# 17q11.2	del/dup	(NF1)	>50%	of	critical	region,	affecting	NF1
if((x=="17q11.2 del (NF1)" | x=="17q11.2 dup (NF1)") & size_greater_50 & length(grep("NF1",CNV.ND.Line$GENES))>0){
CNV.ND.Line$CRITERIA_MET=1
}
# SmithâMagenis/PotockiâLupski	Syndrome	Size	>50%	of	critical	region
if((x=="Smith-Magenis syndrome del" | x=="Potocki-Lupski syndrome dup") & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# 17q11.2	del/dup	(NF1)		 Size	>50%	of	critical	region,	affecting	NF1
if((x=="17q11.2 del (NF1)" | x=="17q11.2 dup (NF1)") & size_greater_50 & length(grep("NF1",CNV.ND.Line$GENES))>0){
CNV.ND.Line$CRITERIA_MET=1
}
# 17q12	del/dup		 Size	>50%	of	critical	region
if((x=="17q12 del" | x=="17q12 dup" | x=="Renal cysts and diabetes syndrome del") & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# 17q21.31	del/dup		 Size	>50%	of	critical	region
if((x=="17q21.31 del" | x=="17q21.31 dup") & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# 17q23.1q23.2	del		 Size	>50%	of	critical	region
if(x=="17q23.1q23.2 del" & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# 17p12       del              Size   >50%    of      critical        region
if(x=="17p12 del" & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# 22q11.2	del/dup		 Size	>50%	of	critical	region
if((x=="22q11.2 del" | x=="22q11.2 dup") & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# 22q11.2	distal	del/dup		 Size	>50%	of	critical	region
if((x=="22q11.2 distal del" | x=="22q11.2 distal dup") & size_greater_50){
CNV.ND.Line$CRITERIA_MET=1
}
# SHANK3 del/dup	 At	least	1Mbp	CNVs,	including	SHANK3
if((x=="SHANK3 del" | x=="SHANK3 dup") & length(grep("SHANK3",CNV.ND.Line$GENES))>0 & greater_than_1mbp){
CNV.ND.Line$CRITERIA_MET=1
}
CNV.ND.Line
})))
})))
patho.criteria.met <- cnv_patho_criteria[which(cnv_patho_criteria$CRITERIA_MET==1),]
patho.criteria.met.no.nested <- as.data.frame(do.call(rbind,lapply(unique(patho.criteria.met$ID),function(x){
### Select row with individual and criteria met
### Selects individuals who have criteria =1
a=patho.criteria.met[which(patho.criteria.met$ID==x),]
if(nrow(a)==1){
a
} else if(nrow(a)>1){
### Check nested TAR / 1q21, remove TAR from the results row
if((length(grep("TAR",a$V1))+length(grep("1q21",a$V1)))==2){
b1=a[-grep("TAR",a$V1),]
b1
}
### Check nested 15q11.2 in PWS/AS
if((length(grep("15q",a$V1))+length(grep("PWS",a$V1)))==2){
b2=a[-grep("15q",a$V1),]
b2
}
### Check nested 16p11.2 distal within
if((length(grep("distal",a$V1))+length(grep("16p11.2 del",a$V1)))==2){
b3=a[-grep("distal",a$V1),]
b3
}
###  A final statement to deal with what happens if there are still two separate records for an individual
### This just prints all lines. Note this does not deal with multiple ND CNVs at the same locus.
if(exists("b1")==F & exists("b2")==F & exists("b3")==F ){
a
}  else if(exists("b1")==T){
b1
}
else if(exists("b2")==T){
b2
}
else if(exists("b3")==T){
b3
}
}
})))
patho.criteria.met=patho.criteria.met.no.nested # Why? PR
patho.criteria.met=patho.criteria.met[order(as.numeric(as.character(patho.criteria.met[,9])),as.numeric(as.character(patho.criteria.met[,10]))),]
cnv.patho=as.data.frame(table(patho.criteria.met$V1))
cnv.patho=unique(merge(patho.criteria.met[,c(12,9,10)],cnv.patho,by.x="V1",by.y="Var1",sort=F)[,c(1,4)])
cnv.patho$DATASET="NOV25"
names(cnv.patho)=c("Neurodevelopmental CNV","N","DATASET")
CalledCNVS<- rbind(patho.criteria.met.no.nested,cnv_patho_criteria[which(cnv_patho_criteria$CRITERIA_MET==0),])
# TODO Need to automatically add an R output folder
write.table(CalledCNVS,
file="./tmp_scratch/FullDataTable_reclustered/output/Routput/called_cnvs.txt",
col.names=T,
row.names=F,
quote=F,
sep="\t")
write.csv(CalledCNVS,
file="./tmp_scratch/FullDataTable_reclustered/output/Routput/called_cnvs.csv",
col.names=T)
################################################################################################
# call this something else, probably a legacy from cells?
non_iPS_dir <- "./tmp_scratch/FullDataTable_reclustered/output/split_files/"
invisible(lapply(unique(patho.criteria.met$ID),function(x){
#browser()
# This is taking the whole row of unique ID
patho.id=patho.criteria.met[which(patho.criteria.met$ID==x),]
if(nrow(patho.id)==1){
browser()
#name <-
patho.cnv.lower.coords <- as.numeric(as.character(patho.id[,10]))-(patho.id[1,3]*1.3)
patho.cnv.upper.coords=as.numeric(as.character(patho.id[,11]))+(patho.id[1,3]*1.3)
patho.cnv_chr=as.numeric(as.character(patho.id[,9]))
cnv.raw=as.data.frame(fread(input=x),header=T,sep="\t")# all need to be in same folder
cnv.raw.params=cnv.raw[which(cnv.raw$Position>=patho.cnv.lower.coords & cnv.raw$Position<=patho.cnv.upper.coords & cnv.raw$Chr==patho.cnv_chr),]
cnv.raw.params$GROUP=c("Probes outside called CNV")
cnv.raw.params[which(cnv.raw.params$Position>=as.numeric(as.character(patho.id[,10])) & cnv.raw.params$Position<=as.numeric(as.character(patho.id[,11])) & cnv.raw.params$Chr==patho.cnv_chr),]$GROUP=c("Probes within individually called CNV")
cnv.raw.params$GROUP <- factor(cnv.raw.params$GROUP, levels = c("Probes within individually called CNV","Probes outside called CNV"))
baf.col=grep("Allele",names(cnv.raw.params))
logr.col=grep("Log",names(cnv.raw.params))
# This should work, but if it's completely broken other functions below
base_position_figure <- function(type = "baf"){
if (type == "baf"){
y_params = cnv.raw.params[,baf.col]
y_title <- "B-Allele Frequency"
}
else if (type == "lrr"){
y_params = cnv.raw.params[,logr.col]
y_title <- "Log R Ratio"
}
else {
stop("Unknown type. Use 'baf' or 'lrr'.")
}
figure=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=y_params,color=as.factor(GROUP))) +
geom_point(shape=1) +
xlab("Base Position")+
ylab(y_title)+
ggtitle(paste(x,patho.id$V1,sep=" "))+
geom_hline(yintercept=0.5, linetype="dashed", color = "Black")+
geom_vline(xintercept=patho.id[,14], linetype="dashed", color = "Green")+
geom_vline(xintercept=patho.id[,15], linetype="dashed", color = "Green")+
ylim(c(0,1))+
labs(color="CNV Probe Legend")
return (figure)
}
baf <- base_position_figure("baf")
lrr <- base_position_figure("lrr")
# TODO fix the name to something shorter
combined_plot <- grid.arrange(arrangeGrob(baf,lrr,ncol=1))
png(paste("./tmp_scratch/FullDataTable_reclustered/output/Routput/plots/",combined_plot,".",patho.id$V1,".png",sep=""), width = 10, height = 4, units = 'in', res = 300)
grid.arrange(arrangeGrob(baf,lrr,ncol=1))
dev.off()
}
else if(nrow(patho.id)>1){
lapply(1:nrow(patho.id),function(y){
patho.cnv.lower.coords=as.numeric(as.character(patho.id[y,10]))-(patho.id[y,3]*1.3)
patho.cnv.upper.coords=as.numeric(as.character(patho.id[y,11]))+(patho.id[y,3]*1.3)
patho.cnv_chr=as.numeric(as.character(patho.id[y,9]))
cnv.raw=as.data.frame(fread(paste0(non_iPS_dir,x,sep=""),header=T,sep="\t"))
cnv.raw.params=cnv.raw[which(cnv.raw$Position>=patho.cnv.lower.coords & cnv.raw$Position<=patho.cnv.upper.coords & cnv.raw$Chr==patho.cnv_chr),]
cnv.raw.params$GROUP=c("Probes outside called CNV")
cnv.raw.params[which(cnv.raw.params$Position>=as.numeric(as.character(patho.id[y,10])) & cnv.raw.params$Position<=as.numeric(as.character(patho.id[y,11])) & cnv.raw.params$Chr==patho.cnv_chr),]$GROUP=c("Probes within individually called CNV")
cnv.raw.params$GROUP <- factor(cnv.raw.params$GROUP, levels = c("Probes within individually called CNV","Probes outside called CNV"))
# baf=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=cnv.raw.params[,baf.col],color=as.factor(GROUP))) +
#   geom_point(shape=1) +
#   xlab("Base Position")+
#   ylab("B-Allele Frequency")+
#   ggtitle(paste(x,patho.id$V1,sep=" "))+
#   geom_hline(yintercept=0.5, linetype="dashed", color = "Black")+
#   geom_vline(xintercept=patho.id[y,14], linetype="dashed", color = "Green")+
#   geom_vline(xintercept=patho.id[y,15], linetype="dashed", color = "Green")+
#   ylim(c(0,1))+
#   labs(color="CNV Probe Legend")
#
# lrr=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=cnv.raw.params[,logr.col],color=as.factor(GROUP))) +
#   geom_point(shape=1) +
#   xlab("Base Position")+
#   ylab("Log R Ratio")+
#   ylim(c(-1,1))+
#   geom_hline(yintercept=0, linetype="dashed", color = "Black")+
#   geom_vline(xintercept=patho.id[y,14], linetype="dashed", color = "Green")+
#   geom_vline(xintercept=patho.id[y,15], linetype="dashed", color = "Green")+
#   labs(color="CNV Probe Legend")
#
#       grid.arrange(arrangeGrob(baf,lrr,ncol=1))
#
#       png(paste("C:\\Users\\sapjeh\\OneDrive - Cardiff University\\Sleep Detectives\\Family Environment Analysis\\Genotyping\\Pipeline\\NeuroDevelopmentalPlots\\",x,".",patho.id$V1,".png",sep=""), width = 10, height = 4, units = 'in', res = 300)
#       grid.arrange(arrangeGrob(baf,lrr,ncol=1))
#       dev.off()
})
}
}))
invisible(lapply(unique(patho.criteria.met$ID),function(x){
#browser()
# This is taking the whole row of unique ID
patho.id=patho.criteria.met[which(patho.criteria.met$ID==x),]
if(nrow(patho.id)==1){
browser()
#name <-
patho.cnv.lower.coords <- as.numeric(as.character(patho.id[,10]))-(patho.id[1,3]*1.3)
patho.cnv.upper.coords=as.numeric(as.character(patho.id[,11]))+(patho.id[1,3]*1.3)
patho.cnv_chr=as.numeric(as.character(patho.id[,9]))
cnv.raw=as.data.frame(fread(input=x),header=T,sep="\t")# all need to be in same folder
cnv.raw.params=cnv.raw[which(cnv.raw$Position>=patho.cnv.lower.coords & cnv.raw$Position<=patho.cnv.upper.coords & cnv.raw$Chr==patho.cnv_chr),]
cnv.raw.params$GROUP=c("Probes outside called CNV")
cnv.raw.params[which(cnv.raw.params$Position>=as.numeric(as.character(patho.id[,10])) & cnv.raw.params$Position<=as.numeric(as.character(patho.id[,11])) & cnv.raw.params$Chr==patho.cnv_chr),]$GROUP=c("Probes within individually called CNV")
cnv.raw.params$GROUP <- factor(cnv.raw.params$GROUP, levels = c("Probes within individually called CNV","Probes outside called CNV"))
baf.col=grep("Allele",names(cnv.raw.params))
logr.col=grep("Log",names(cnv.raw.params))
# This should work, but if it's completely broken other functions below
base_position_figure <- function(type = "baf"){
if (type == "baf"){
y_params = cnv.raw.params[,baf.col]
y_title <- "B-Allele Frequency"
}
else if (type == "lrr"){
y_params = cnv.raw.params[,logr.col]
y_title <- "Log R Ratio"
}
else {
stop("Unknown type. Use 'baf' or 'lrr'.")
}
figure=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=y_params,color=as.factor(GROUP))) +
geom_point(shape=1) +
xlab("Base Position")+
ylab(y_title)+
ggtitle(paste(x,patho.id$V1,sep=" "))+
geom_hline(yintercept=0.5, linetype="dashed", color = "Black")+
geom_vline(xintercept=patho.id[,14], linetype="dashed", color = "Green")+
geom_vline(xintercept=patho.id[,15], linetype="dashed", color = "Green")+
ylim(c(0,1))+
labs(color="CNV Probe Legend")
return (figure)
}
baf <- base_position_figure("baf")
lrr <- base_position_figure("lrr")
# TODO fix the name to something shorter
combined_plot <- grid.arrange(arrangeGrob(baf,lrr,ncol=1))
png(paste("./tmp_scratch/FullDataTable_reclustered/output/Routput/plots/",combined_plot,".",patho.id$V1,".png",sep=""), width = 10, height = 4, units = 'in', res = 300)
grid.arrange(arrangeGrob(baf,lrr,ncol=1))
dev.off()
}
else if(nrow(patho.id)>1){
lapply(1:nrow(patho.id),function(y){
patho.cnv.lower.coords=as.numeric(as.character(patho.id[y,10]))-(patho.id[y,3]*1.3)
patho.cnv.upper.coords=as.numeric(as.character(patho.id[y,11]))+(patho.id[y,3]*1.3)
patho.cnv_chr=as.numeric(as.character(patho.id[y,9]))
cnv.raw=as.data.frame(fread(paste0(non_iPS_dir,x,sep=""),header=T,sep="\t"))
cnv.raw.params=cnv.raw[which(cnv.raw$Position>=patho.cnv.lower.coords & cnv.raw$Position<=patho.cnv.upper.coords & cnv.raw$Chr==patho.cnv_chr),]
cnv.raw.params$GROUP=c("Probes outside called CNV")
cnv.raw.params[which(cnv.raw.params$Position>=as.numeric(as.character(patho.id[y,10])) & cnv.raw.params$Position<=as.numeric(as.character(patho.id[y,11])) & cnv.raw.params$Chr==patho.cnv_chr),]$GROUP=c("Probes within individually called CNV")
cnv.raw.params$GROUP <- factor(cnv.raw.params$GROUP, levels = c("Probes within individually called CNV","Probes outside called CNV"))
# baf=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=cnv.raw.params[,baf.col],color=as.factor(GROUP))) +
#   geom_point(shape=1) +
#   xlab("Base Position")+
#   ylab("B-Allele Frequency")+
#   ggtitle(paste(x,patho.id$V1,sep=" "))+
#   geom_hline(yintercept=0.5, linetype="dashed", color = "Black")+
#   geom_vline(xintercept=patho.id[y,14], linetype="dashed", color = "Green")+
#   geom_vline(xintercept=patho.id[y,15], linetype="dashed", color = "Green")+
#   ylim(c(0,1))+
#   labs(color="CNV Probe Legend")
#
# lrr=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=cnv.raw.params[,logr.col],color=as.factor(GROUP))) +
#   geom_point(shape=1) +
#   xlab("Base Position")+
#   ylab("Log R Ratio")+
#   ylim(c(-1,1))+
#   geom_hline(yintercept=0, linetype="dashed", color = "Black")+
#   geom_vline(xintercept=patho.id[y,14], linetype="dashed", color = "Green")+
#   geom_vline(xintercept=patho.id[y,15], linetype="dashed", color = "Green")+
#   labs(color="CNV Probe Legend")
#
#       grid.arrange(arrangeGrob(baf,lrr,ncol=1))
#
#       png(paste("C:\\Users\\sapjeh\\OneDrive - Cardiff University\\Sleep Detectives\\Family Environment Analysis\\Genotyping\\Pipeline\\NeuroDevelopmentalPlots\\",x,".",patho.id$V1,".png",sep=""), width = 10, height = 4, units = 'in', res = 300)
#       grid.arrange(arrangeGrob(baf,lrr,ncol=1))
#       dev.off()
})
}
}))
invisible(lapply(unique(patho.criteria.met$ID),function(x){
#browser()
# This is taking the whole row of unique ID
patho.id=patho.criteria.met[which(patho.criteria.met$ID==x),]
if(nrow(patho.id)==1){
#browser()
#name <-
patho.cnv.lower.coords <- as.numeric(as.character(patho.id[,10]))-(patho.id[1,3]*1.3)
patho.cnv.upper.coords=as.numeric(as.character(patho.id[,11]))+(patho.id[1,3]*1.3)
patho.cnv_chr=as.numeric(as.character(patho.id[,9]))
cnv.raw=as.data.frame(fread(input=x),header=T,sep="\t")# all need to be in same folder
cnv.raw.params=cnv.raw[which(cnv.raw$Position>=patho.cnv.lower.coords & cnv.raw$Position<=patho.cnv.upper.coords & cnv.raw$Chr==patho.cnv_chr),]
cnv.raw.params$GROUP=c("Probes outside called CNV")
cnv.raw.params[which(cnv.raw.params$Position>=as.numeric(as.character(patho.id[,10])) & cnv.raw.params$Position<=as.numeric(as.character(patho.id[,11])) & cnv.raw.params$Chr==patho.cnv_chr),]$GROUP=c("Probes within individually called CNV")
cnv.raw.params$GROUP <- factor(cnv.raw.params$GROUP, levels = c("Probes within individually called CNV","Probes outside called CNV"))
baf.col=grep("Allele",names(cnv.raw.params))
logr.col=grep("Log",names(cnv.raw.params))
# This should work, but if it's completely broken other functions below
base_position_figure <- function(type = "baf"){
if (type == "baf"){
y_params = cnv.raw.params[,baf.col]
y_title <- "B-Allele Frequency"
}
else if (type == "lrr"){
y_params = cnv.raw.params[,logr.col]
y_title <- "Log R Ratio"
}
else {
stop("Unknown type. Use 'baf' or 'lrr'.")
}
figure=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=y_params,color=as.factor(GROUP))) +
geom_point(shape=1) +
xlab("Base Position")+
ylab(y_title)+
ggtitle(paste(x,patho.id$V1,sep=" "))+
geom_hline(yintercept=0.5, linetype="dashed", color = "Black")+
geom_vline(xintercept=patho.id[,14], linetype="dashed", color = "Green")+
geom_vline(xintercept=patho.id[,15], linetype="dashed", color = "Green")+
ylim(c(0,1))+
labs(color="CNV Probe Legend")
return (figure)
}
baf <- base_position_figure("baf")
lrr <- base_position_figure("lrr")
# TODO fix the name to something shorter
combined_plot <- grid.arrange(arrangeGrob(baf,lrr,ncol=1))
png(paste("./tmp_scratch/FullDataTable_reclustered/output/Routput/plots/",combined_plot,".",patho.id$V1,".png",sep=""), width = 10, height = 4, units = 'in', res = 300)
grid.arrange(arrangeGrob(baf,lrr,ncol=1))
dev.off()
}
else if(nrow(patho.id)>1){
lapply(1:nrow(patho.id),function(y){
patho.cnv.lower.coords=as.numeric(as.character(patho.id[y,10]))-(patho.id[y,3]*1.3)
patho.cnv.upper.coords=as.numeric(as.character(patho.id[y,11]))+(patho.id[y,3]*1.3)
patho.cnv_chr=as.numeric(as.character(patho.id[y,9]))
cnv.raw=as.data.frame(fread(paste0(non_iPS_dir,x,sep=""),header=T,sep="\t"))
cnv.raw.params=cnv.raw[which(cnv.raw$Position>=patho.cnv.lower.coords & cnv.raw$Position<=patho.cnv.upper.coords & cnv.raw$Chr==patho.cnv_chr),]
cnv.raw.params$GROUP=c("Probes outside called CNV")
cnv.raw.params[which(cnv.raw.params$Position>=as.numeric(as.character(patho.id[y,10])) & cnv.raw.params$Position<=as.numeric(as.character(patho.id[y,11])) & cnv.raw.params$Chr==patho.cnv_chr),]$GROUP=c("Probes within individually called CNV")
cnv.raw.params$GROUP <- factor(cnv.raw.params$GROUP, levels = c("Probes within individually called CNV","Probes outside called CNV"))
# baf=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=cnv.raw.params[,baf.col],color=as.factor(GROUP))) +
#   geom_point(shape=1) +
#   xlab("Base Position")+
#   ylab("B-Allele Frequency")+
#   ggtitle(paste(x,patho.id$V1,sep=" "))+
#   geom_hline(yintercept=0.5, linetype="dashed", color = "Black")+
#   geom_vline(xintercept=patho.id[y,14], linetype="dashed", color = "Green")+
#   geom_vline(xintercept=patho.id[y,15], linetype="dashed", color = "Green")+
#   ylim(c(0,1))+
#   labs(color="CNV Probe Legend")
#
# lrr=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=cnv.raw.params[,logr.col],color=as.factor(GROUP))) +
#   geom_point(shape=1) +
#   xlab("Base Position")+
#   ylab("Log R Ratio")+
#   ylim(c(-1,1))+
#   geom_hline(yintercept=0, linetype="dashed", color = "Black")+
#   geom_vline(xintercept=patho.id[y,14], linetype="dashed", color = "Green")+
#   geom_vline(xintercept=patho.id[y,15], linetype="dashed", color = "Green")+
#   labs(color="CNV Probe Legend")
#
#       grid.arrange(arrangeGrob(baf,lrr,ncol=1))
#
#       png(paste("C:\\Users\\sapjeh\\OneDrive - Cardiff University\\Sleep Detectives\\Family Environment Analysis\\Genotyping\\Pipeline\\NeuroDevelopmentalPlots\\",x,".",patho.id$V1,".png",sep=""), width = 10, height = 4, units = 'in', res = 300)
#       grid.arrange(arrangeGrob(baf,lrr,ncol=1))
#       dev.off()
})
}
}))
invisible(lapply(unique(patho.criteria.met$ID),function(x){
browser()
# This is taking the whole row of unique ID
patho.id=patho.criteria.met[which(patho.criteria.met$ID==x),]
if(nrow(patho.id)==1){
#browser()
#name <-
patho.cnv.lower.coords <- as.numeric(as.character(patho.id[,10]))-(patho.id[1,3]*1.3)
patho.cnv.upper.coords=as.numeric(as.character(patho.id[,11]))+(patho.id[1,3]*1.3)
patho.cnv_chr=as.numeric(as.character(patho.id[,9]))
cnv.raw=as.data.frame(fread(input=x),header=T,sep="\t")# all need to be in same folder
cnv.raw.params=cnv.raw[which(cnv.raw$Position>=patho.cnv.lower.coords & cnv.raw$Position<=patho.cnv.upper.coords & cnv.raw$Chr==patho.cnv_chr),]
cnv.raw.params$GROUP=c("Probes outside called CNV")
cnv.raw.params[which(cnv.raw.params$Position>=as.numeric(as.character(patho.id[,10])) & cnv.raw.params$Position<=as.numeric(as.character(patho.id[,11])) & cnv.raw.params$Chr==patho.cnv_chr),]$GROUP=c("Probes within individually called CNV")
cnv.raw.params$GROUP <- factor(cnv.raw.params$GROUP, levels = c("Probes within individually called CNV","Probes outside called CNV"))
baf.col=grep("Allele",names(cnv.raw.params))
logr.col=grep("Log",names(cnv.raw.params))
# This should work, but if it's completely broken other functions below
base_position_figure <- function(type = "baf"){
if (type == "baf"){
y_params = cnv.raw.params[,baf.col]
y_title <- "B-Allele Frequency"
}
else if (type == "lrr"){
y_params = cnv.raw.params[,logr.col]
y_title <- "Log R Ratio"
}
else {
stop("Unknown type. Use 'baf' or 'lrr'.")
}
figure=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=y_params,color=as.factor(GROUP))) +
geom_point(shape=1) +
xlab("Base Position")+
ylab(y_title)+
ggtitle(paste(x,patho.id$V1,sep=" "))+
geom_hline(yintercept=0.5, linetype="dashed", color = "Black")+
geom_vline(xintercept=patho.id[,14], linetype="dashed", color = "Green")+
geom_vline(xintercept=patho.id[,15], linetype="dashed", color = "Green")+
ylim(c(0,1))+
labs(color="CNV Probe Legend")
return (figure)
}
baf <- base_position_figure("baf")
lrr <- base_position_figure("lrr")
# TODO fix the name to something shorter
combined_plot <- grid.arrange(arrangeGrob(baf,lrr,ncol=1))
png(paste("./tmp_scratch/FullDataTable_reclustered/output/Routput/plots/",combined_plot,".",patho.id$V1,".png",sep=""), width = 10, height = 4, units = 'in', res = 300)
grid.arrange(arrangeGrob(baf,lrr,ncol=1))
dev.off()
}
else if(nrow(patho.id)>1){
lapply(1:nrow(patho.id),function(y){
patho.cnv.lower.coords=as.numeric(as.character(patho.id[y,10]))-(patho.id[y,3]*1.3)
patho.cnv.upper.coords=as.numeric(as.character(patho.id[y,11]))+(patho.id[y,3]*1.3)
patho.cnv_chr=as.numeric(as.character(patho.id[y,9]))
cnv.raw=as.data.frame(fread(paste0(non_iPS_dir,x,sep=""),header=T,sep="\t"))
cnv.raw.params=cnv.raw[which(cnv.raw$Position>=patho.cnv.lower.coords & cnv.raw$Position<=patho.cnv.upper.coords & cnv.raw$Chr==patho.cnv_chr),]
cnv.raw.params$GROUP=c("Probes outside called CNV")
cnv.raw.params[which(cnv.raw.params$Position>=as.numeric(as.character(patho.id[y,10])) & cnv.raw.params$Position<=as.numeric(as.character(patho.id[y,11])) & cnv.raw.params$Chr==patho.cnv_chr),]$GROUP=c("Probes within individually called CNV")
cnv.raw.params$GROUP <- factor(cnv.raw.params$GROUP, levels = c("Probes within individually called CNV","Probes outside called CNV"))
# baf=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=cnv.raw.params[,baf.col],color=as.factor(GROUP))) +
#   geom_point(shape=1) +
#   xlab("Base Position")+
#   ylab("B-Allele Frequency")+
#   ggtitle(paste(x,patho.id$V1,sep=" "))+
#   geom_hline(yintercept=0.5, linetype="dashed", color = "Black")+
#   geom_vline(xintercept=patho.id[y,14], linetype="dashed", color = "Green")+
#   geom_vline(xintercept=patho.id[y,15], linetype="dashed", color = "Green")+
#   ylim(c(0,1))+
#   labs(color="CNV Probe Legend")
#
# lrr=ggplot(data=cnv.raw.params,aes(x=cnv.raw.params[,3],y=cnv.raw.params[,logr.col],color=as.factor(GROUP))) +
#   geom_point(shape=1) +
#   xlab("Base Position")+
#   ylab("Log R Ratio")+
#   ylim(c(-1,1))+
#   geom_hline(yintercept=0, linetype="dashed", color = "Black")+
#   geom_vline(xintercept=patho.id[y,14], linetype="dashed", color = "Green")+
#   geom_vline(xintercept=patho.id[y,15], linetype="dashed", color = "Green")+
#   labs(color="CNV Probe Legend")
#
#       grid.arrange(arrangeGrob(baf,lrr,ncol=1))
#
#       png(paste("C:\\Users\\sapjeh\\OneDrive - Cardiff University\\Sleep Detectives\\Family Environment Analysis\\Genotyping\\Pipeline\\NeuroDevelopmentalPlots\\",x,".",patho.id$V1,".png",sep=""), width = 10, height = 4, units = 'in', res = 300)
#       grid.arrange(arrangeGrob(baf,lrr,ncol=1))
#       dev.off()
})
}
}))
View(cnv.raw.params)
